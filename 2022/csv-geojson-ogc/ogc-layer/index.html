<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>WFSLayer</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css" />

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    
      .esri-legend .esri-legend__layer-caption {
        display: none;
      }
    
      #infoDiv {
        padding: 10px;
      }
    </style>

    <script src="https://js.arcgis.com/4.23/"></script>

    <script type="text/plain" id="drought-renderer">
      // Write the expression and reference the value
      // of each field with a meaningful variable name within
      // the expression. Then calculate the max number with
      // the Max() function and use Decode() to return a string
      // value representing the party whose field value matches
      // the max value.

      var persist = $feature.fid_persis;
      var improves = $feature.fid_improv;
      var removal = $feature.fid_remove;
      var development = $feature.fid_dev;
      var droughtValues = [persist, improves, removal, development];

      // Decode() and Max() are built-in Arcade functions
      return Decode( Max(droughtValues),
        persist, 'Drought Persists',
        improves, 'Drought Could Improve',
        removal, 'Drought Could End',
        development, 'Drought Could Develop',
        'n/a');
    </script>

    <script>
      require([
        "esri/Map",
        "esri/layers/WFSLayer",
        "esri/views/MapView",
        "esri/widgets/Legend",
        "esri/smartMapping/renderers/type",
        "esri/layers/support/FeatureEffect"
      ], function(
        Map,
        WFSLayer,
        MapView,
        Legend,
        typeRendererCreator,
        FeatureEffect
      ) {
        // Assign the expression to the `valueExpression` property and
        // set up the unique value infos based on the decode values
        // you set up in the expression.
        const droughtArcade = document.getElementById("drought-renderer").text;

        const popupTemplate = {
          title: "Drought Outlook (Feb - May 2022)",
          content: "The seasonal drought outlook demonstrates <b>{expression/drought-outlook-category}</b> in this region of the United States.",
          expressionInfos: [{
            name: "drought-outlook-category",
            expression: "When($feature.fid_persis == 1, 'drought persistence is likely', $feature.fid_dev == 1, 'potential drought development is likely', $feature.fid_improv == 1, 'drought improvement is favored', $feature.fid_remove == 1, 'drought removal is favored', 'n/a')"
          }]
        }

        // initialize the WFSLayer
        const droughtLayer = new WFSLayer({
          url: "https://idpgis.ncep.noaa.gov/arcgis/services/NWS_Climate_Outlooks/cpc_drought_outlk/MapServer/WFSServer",
          name: "Seasonal_Drought_Outlook",
          title: "US Seasonal Drought Outlook (Feb - May 2022)",
          copyright: "NOAA/NWS/NCEP/Climate Prediction Center",
          popupTemplate: popupTemplate
        });

        const map = new Map({
          basemap: "gray-vector",
          layers: [droughtLayer]
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-100, 34],
          zoom: 4
        });

        const legend = new Legend({
          view: view,
          container: "legendDiv"
        });

        // visualization based on categorical field
        let typeParams = {
          layer: droughtLayer,
          view: view,
          valueExpression: droughtArcade,
          defaultSymbolEnabled: false
        };
        // when the promise resolves, apply the visual variables to the renderer
        typeRendererCreator
          .createRenderer(typeParams)
          .then(function (response) {
            droughtLayer.renderer = response.renderer;
          });

        view.ui.add("infoDiv", "top-right");

        // filter features via the dropdown
        const filterSelect = document.getElementById("filter");

        view.whenLayerView(droughtLayer)
          .then((layerView) => {
            filterSelect.addEventListener("input", (event) => {
              layerView.featureEffect = new FeatureEffect({
                filter: {
                  where: event.target.value
                },
                includedEffect: "drop-shadow(-10px, 10px, 6px gray)",
                excludedEffect: "opacity(30%)"
              });
            });
        });

      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="infoDiv" class="esri-widget">
      <div id="legendDiv"></div>
      <p id="p-heading">Filter by category</p>
      <select id="filter" class="esri-select">
        <option value="1=1">Show all</option>
        <option value="fid_dev=1">Drought Could Develop</option>
        <option value="fid_remove=1">Drought Could End</option>
        <option value="fid_persis=1">Drought Persists</option>
        <option value="fid_improv=1">Drought Could Improve</option>
      </select>
    </div>
  </body>
</html>
